<!DOCTYPE html>
<html>
<head>
  <title>Image Processor</title>
  <link rel="stylesheet" href="static/style.css">
  <link rel="stylesheet" href="static/gamma.css">
  <!-- <style>
    img { max-width: 300px; margin: 10px; }
  </style> -->
</head>
<body>

  <div class="main-container">

    <div class="nav-cont">
        <button onclick="uploadImage()">BW</button>
        <button onclick="removeBG()">Remove BG</button>
        <button onclick="gammaF()">Gamma</button>
    </div>

    <div class="window-cont">

      <div class="h-nav">
        <input type="file" id="fileInput"><br>
        <button onclick="location.reload()">Reload App</button>
      </div>

      <div class="desctop">
        <p id="load">Processing...</p>

        <canvas id="imageCanvas" style="display:none;"></canvas>
        <div id="gammaCont">
          <input type="range" id="gammaSlider" min="0.2" max="3" step="0.1" value="1">
          <label for="gammaSlider">Gamma</label>
        </div>

        <img id="original">
        <img id="imgElem">
      </div>

    </div>

  </div>

  <script>
    let base64Image = '';
    let image = document.getElementById('original')
    let imgElem = document.getElementById('imgElem')
    let load = document.getElementById('load')

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function () {
        base64Image = reader.result;
        image.src = base64Image;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    async function uploadImage() {
      if (!base64Image) return alert("Please select an image first.");

      const result = await window.pywebview.api.process_image(base64Image);
      load.style.display = 'block';
      if (result.status === "success") {
        image.src = result.output_path + '?' + new Date().getTime(); // cache busting
        imgElem.src = result.output_path + '?' + new Date().getTime(); // cache copy busting
        load.style.display = 'none';
      } else {
        alert("Error: " + result.message);
        load.style.display = 'none';
      }
    }

    async function removeBG() {
      if (!base64Image) return alert("Please select an image first.");

      const result = await window.pywebview.api.remove_bg(base64Image);
      if (result.status === "success") {
        image.src = result.output_path + '?' + new Date().getTime(); // cache busting
      } else {
        alert("Error: " + result.message);
      }
    }


    const gammaCont = document.getElementById('gammaCont');
    const gammaSlider = document.getElementById("gammaSlider");
    // const imgElem   = document.getElementById('imgElem');
    const canvas       = document.getElementById("imageCanvas");
    const ctx          = canvas.getContext("2d");

    function gammaF() {     
      if (gammaCont.style.display === 'none') {
        gammaCont.style.display = 'block';
      } else {
        gammaCont.style.display = 'none';
      }
    }

    gammaSlider.addEventListener("input", () => {
      applyGammaCorrection(parseFloat(gammaSlider.value));
    });

    function applyGammaCorrection(gamma) {
      if (!image.src) return;
      
      // Draw original into canvas at its natural size
      const w = image.naturalWidth;
      const h = image.naturalHeight;
      canvas.width  = w;
      canvas.height = h;
      ctx.drawImage(image, 0, 0, w, h);

      // Now grab the pixel data
      const imageData = ctx.getImageData(0, 0, w, h);
      const data      = imageData.data;
      
      // Build LUT
      const invGamma = 1 / gamma;
      const LUT = new Uint8ClampedArray(256);
      for (let i = 0; i < 256; i++) {
        LUT[i] = Math.min(255, Math.pow(i / 255, invGamma) * 255);
      }
      
      // Apply to each pixel
      for (let i = 0; i < data.length; i += 4) {
        data[i]     = LUT[data[i]];     // R
        data[i + 1] = LUT[data[i + 1]]; // G
        data[i + 2] = LUT[data[i + 2]]; // B
        // alpha unchanged
      }
      
      // Put back and update img
      ctx.putImageData(imageData, 0, 0);
      image.src = canvas.toDataURL();
    }


  </script>
  <script src="./js/gamma.js"></script>
</body>
</html>
